<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Tlangau</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.used {
            background: #d4edda;
            color: #155724;
        }

        .badge.unused {
            background: #cce5ff;
            color: #004085;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .error {
            color: #dc3545;
            margin-top: 10px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 6px;
        }

        .success {
            color: #155724;
            margin-top: 10px;
            padding: 10px;
            background: #d4edda;
            border-radius: 6px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .logout-btn {
            float: right;
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 12px;
            width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h1>üîê Admin Login</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="password">Admin Password</label>
                <input type="password" id="password" required autocomplete="off" autofocus>
            </div>
            <button type="submit" class="btn" id="loginBtn">Login</button>
            <div id="loginError" class="error" style="display: none;"></div>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <div class="header">
                <button class="logout-btn" id="logoutBtn">Logout</button>
                <h1>üìä Admin Dashboard</h1>
                <p>Manage orders, access codes, users, and view statistics</p>
            </div>

            <!-- Statistics -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="value" id="statTotalOrders">-</div>
                </div>
                <div class="stat-card">
                    <h3>Successful Orders</h3>
                    <div class="value" id="statSuccessfulOrders">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <div class="value" id="statRevenue">‚Çπ-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Codes</h3>
                    <div class="value" id="statTotalCodes">-</div>
                </div>
                <div class="stat-card">
                    <h3>Used Codes</h3>
                    <div class="value" id="statUsedCodes">-</div>
                </div>
                <div class="stat-card">
                    <h3>Unused Codes</h3>
                    <div class="value" id="statUnusedCodes">-</div>
                </div>
                <div class="stat-card">
                    <h3>Unique Users</h3>
                    <div class="value" id="statUniqueUsers">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="tabsBar">
                <button class="tab active" data-tab="orders">Orders</button>
                <button class="tab" data-tab="codes">Access Codes</button>
                <button class="tab" data-tab="users">Users</button>
                <button class="tab" data-tab="bundles">Bundles & Topics</button>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content active">
                <div class="table-container">
                    <input type="text" class="search-box" id="ordersSearch" placeholder="Search orders by email, order ID, or payment ID...">
                    <div id="ordersLoading" class="loading">Loading orders...</div>
                    <table id="ordersTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Email</th>
                                <th>Amount</th>
                                <th>Services</th>
                                <th>Status</th>
                                <th>Payment ID</th>
                                <th>Created At</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Access Codes Tab -->
            <div id="codesTab" class="tab-content">
                <div class="table-container">
                    <input type="text" class="search-box" id="codesSearch" placeholder="Search codes by code, email, or order ID...">
                    <div id="codesLoading" class="loading">Loading access codes...</div>
                    <table id="codesTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Email</th>
                                <th>Order ID</th>
                                <th>Services</th>
                                <th>Status</th>
                                <th>Used By</th>
                                <th>Expires At</th>
                                <th>Created At</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="codesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="table-container">
                    <input type="text" class="search-box" id="usersSearch" placeholder="Search users by email...">
                    <div id="usersLoading" class="loading">Loading users...</div>
                    <table id="usersTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Total Orders</th>
                                <th>Successful Orders</th>
                                <th>Total Spent</th>
                                <th>First Order</th>
                                <th>Last Order</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bundles & Topics Tab -->
            <div id="bundlesTab" class="tab-content">
                <div class="table-container">
                    <input type="text" class="search-box" id="bundlesSearch" placeholder="Search bundles or topics...">
                    <div id="bundlesLoading" class="loading">Loading bundles and topics...</div>
                    <div id="bundlesContainer" style="display: none;">
                        <div id="bundlesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const BACKEND_URL = window.BACKEND_URL || 'http://localhost:3001';
        let adminPassword = '';

        // ==================== EVENT LISTENERS (CSP-safe, no inline handlers) ====================

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password }),
                });

                const data = await response.json();

                if (data.success) {
                    adminPassword = password;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    loadDashboard();
                } else {
                    errorDiv.textContent = data.error || 'Invalid password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Failed to connect to server: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', function () {
            if (confirm('Are you sure you want to logout?')) {
                adminPassword = '';
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('password').value = '';
            }
        });

        // Tab buttons (event delegation on tabs bar)
        document.getElementById('tabsBar').addEventListener('click', function (e) {
            const btn = e.target.closest('[data-tab]');
            if (!btn) return;
            switchTab(btn.dataset.tab);
        });

        // Search boxes
        document.getElementById('ordersSearch').addEventListener('keyup', function () {
            filterTable('ordersTable', 'ordersSearch');
        });
        document.getElementById('codesSearch').addEventListener('keyup', function () {
            filterTable('codesTable', 'codesSearch');
        });
        document.getElementById('usersSearch').addEventListener('keyup', function () {
            filterTable('usersTable', 'usersSearch');
        });
        document.getElementById('bundlesSearch').addEventListener('keyup', function () {
            filterBundlesTable();
        });

        // Event delegation for dynamically created delete buttons
        document.getElementById('ordersBody').addEventListener('click', function (e) {
            const btn = e.target.closest('[data-delete-order]');
            if (btn) deleteOrder(btn.dataset.deleteOrder);
        });
        document.getElementById('codesBody').addEventListener('click', function (e) {
            const btn = e.target.closest('[data-delete-code]');
            if (btn) deleteCode(btn.dataset.deleteCode);
        });
        document.getElementById('usersBody').addEventListener('click', function (e) {
            const btn = e.target.closest('[data-delete-user]');
            if (btn) deleteUser(btn.dataset.deleteUser);
        });
        document.getElementById('bundlesList').addEventListener('click', function (e) {
            const delBundle = e.target.closest('[data-delete-bundle]');
            if (delBundle) {
                deleteBundle(delBundle.dataset.deleteBundle, delBundle.dataset.bundleName);
                return;
            }
            const delTopic = e.target.closest('[data-delete-topic]');
            if (delTopic) {
                deleteTopic(delTopic.dataset.bundleId, delTopic.dataset.deleteTopic, delTopic.dataset.topicName);
            }
        });

        // ==================== DASHBOARD DATA ====================

        async function loadDashboard() {
            await Promise.all([
                loadStatistics(),
                loadOrders(),
                loadAccessCodes(),
                loadUsers(),
                loadBundles(),
            ]);
        }

        async function loadStatistics() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/statistics`, {
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();

                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('statTotalOrders').textContent = stats.totalOrders;
                    document.getElementById('statSuccessfulOrders').textContent = stats.successfulOrders;
                    document.getElementById('statRevenue').textContent = `‚Çπ${stats.totalRevenue.toFixed(2)}`;
                    document.getElementById('statTotalCodes').textContent = stats.totalCodes;
                    document.getElementById('statUsedCodes').textContent = stats.usedCodes;
                    document.getElementById('statUnusedCodes').textContent = stats.unusedCodes;
                    document.getElementById('statUniqueUsers').textContent = stats.uniqueUsers;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Helper: escape HTML to prevent XSS in dynamic content
        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        async function loadOrders() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/orders`, {
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('ordersBody');
                    tbody.innerHTML = '';

                    if (data.orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üì¶</div><p>No orders found</p></td></tr>';
                    } else {
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            const amount = (order.amount / 100).toFixed(2);
                            const statusBadge = `<span class="badge ${esc(order.status.toLowerCase())}">${esc(order.status)}</span>`;
                            const services = order.services || [];
                            const servicesBadges = services.length > 0
                                ? services.map(s => `<span class="badge" style="background:#e8eaf6;color:#3949ab;margin:1px;font-size:10px;">${esc(s)}</span>`).join(' ')
                                : '<span style="color:#999;font-size:12px;">All (legacy)</span>';
                            row.innerHTML = `
                                <td>${esc(order.order_id)}</td>
                                <td>${esc(order.email)}</td>
                                <td>‚Çπ${esc(amount)}</td>
                                <td>${servicesBadges}</td>
                                <td>${statusBadge}</td>
                                <td>${esc(order.payment_id || '-')}</td>
                                <td>${esc(new Date(order.created_at).toLocaleString())}</td>
                                <td>
                                    <button class="btn-danger" data-delete-order="${esc(order.order_id)}">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }

                    document.getElementById('ordersLoading').style.display = 'none';
                    document.getElementById('ordersTable').style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersLoading').textContent = 'Error loading orders: ' + error.message;
            }
        }

        async function loadAccessCodes() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/access-codes`, {
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('codesBody');
                    tbody.innerHTML = '';

                    if (data.codes.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üîë</div><p>No access codes found</p></td></tr>';
                    } else {
                        data.codes.forEach(code => {
                            const row = document.createElement('tr');
                            const statusBadge = code.used 
                                ? '<span class="badge used">Used</span>'
                                : '<span class="badge unused">Unused</span>';
                            const expiresAtRaw = code.expires_at || code.expiresAt;
                            let expiresAt = new Date(expiresAtRaw);
                            
                            if (isNaN(expiresAt.getTime()) && code.created_at) {
                                expiresAt = new Date(new Date(code.created_at).getTime() + 30 * 24 * 60 * 60 * 1000);
                            }
                            
                            const isExpired = expiresAt < new Date();
                            const expiresText = isNaN(expiresAt.getTime()) 
                                ? '<span style="color: #dc3545;">Unknown</span>'
                                : (isExpired 
                                    ? `<span style="color: #dc3545;">${esc(expiresAt.toLocaleString())} (Expired)</span>`
                                    : esc(expiresAt.toLocaleString()));
                            
                            const services = code.services || [];
                            const servicesBadges = services.length > 0
                                ? services.map(s => `<span class="badge" style="background:#e8eaf6;color:#3949ab;margin:1px;font-size:10px;">${esc(s)}</span>`).join(' ')
                                : '<span style="color:#999;font-size:12px;">All (legacy)</span>';

                            row.innerHTML = `
                                <td><strong>${esc(code.code)}</strong></td>
                                <td>${esc(code.email)}</td>
                                <td>${esc(code.order_id)}</td>
                                <td>${servicesBadges}</td>
                                <td>${statusBadge}</td>
                                <td>${esc(code.used_by_email || '-')}</td>
                                <td>${expiresText}</td>
                                <td>${esc(new Date(code.created_at).toLocaleString())}</td>
                                <td>
                                    <button class="btn-danger" data-delete-code="${esc(code.code)}">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }

                    document.getElementById('codesLoading').style.display = 'none';
                    document.getElementById('codesTable').style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading access codes:', error);
                document.getElementById('codesLoading').textContent = 'Error loading access codes: ' + error.message;
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/users`, {
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('usersBody');
                    tbody.innerHTML = '';

                    if (data.users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üë•</div><p>No users found</p></td></tr>';
                    } else {
                        data.users.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${esc(user.email)}</td>
                                <td>${user.totalOrders}</td>
                                <td>${user.successfulOrders}</td>
                                <td>‚Çπ${user.totalSpent.toFixed(2)}</td>
                                <td>${esc(new Date(user.firstOrder).toLocaleString())}</td>
                                <td>${esc(new Date(user.lastOrder).toLocaleString())}</td>
                                <td>
                                    <button class="btn-danger" data-delete-user="${esc(user.email)}">Delete All Data</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }

                    document.getElementById('usersLoading').style.display = 'none';
                    document.getElementById('usersTable').style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersLoading').textContent = 'Error loading users: ' + error.message;
            }
        }

        async function loadBundles() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/bundles`, {
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('bundlesList');
                    container.innerHTML = '';

                    if (data.bundles.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No bundles found</p></div>';
                    } else {
                        data.bundles.forEach(bundle => {
                            const bundleCard = document.createElement('div');
                            bundleCard.style.cssText = 'background: #f9f9f9; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #e0e0e0;';
                            
                            let topicsHtml = '';
                            if (bundle.topics.length === 0) {
                                topicsHtml = '<p style="color: #666; font-style: italic;">No topics in this bundle</p>';
                            } else {
                                topicsHtml = '<table style="width: 100%; margin-top: 10px;"><thead><tr><th>Topic Name</th><th>FCM Topic</th><th>Subscribers</th><th>Action</th></tr></thead><tbody>';
                                bundle.topics.forEach(topic => {
                                    topicsHtml += `
                                        <tr>
                                            <td><strong>${esc(topic.name)}</strong></td>
                                            <td><code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${esc(topic.fcmTopicName)}</code></td>
                                            <td>${topic.subscribers}</td>
                                            <td>
                                                <button class="btn-danger" data-delete-topic="${esc(topic.id)}" data-bundle-id="${esc(bundle.id)}" data-topic-name="${esc(topic.name)}">Delete Topic</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                                topicsHtml += '</tbody></table>';
                            }

                            bundleCard.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="margin: 0; color: #667eea; font-size: 20px;">${esc(bundle.name)}</h3>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                            Bundle ID: <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${esc(bundle.id)}</code>
                                            | ${bundle.topicsCount} topic${bundle.topicsCount !== 1 ? 's' : ''}
                                        </p>
                                    </div>
                                    <button class="btn-danger" data-delete-bundle="${esc(bundle.id)}" data-bundle-name="${esc(bundle.name)}" style="padding: 10px 20px; font-size: 14px;">
                                        Delete Bundle
                                    </button>
                                </div>
                                ${topicsHtml}
                            `;
                            container.appendChild(bundleCard);
                        });
                    }

                    document.getElementById('bundlesLoading').style.display = 'none';
                    document.getElementById('bundlesContainer').style.display = 'block';
                } else {
                    if (data.error && data.error.includes('Firebase Admin not initialized')) {
                        document.getElementById('bundlesLoading').innerHTML = `
                            <div class="error">
                                <strong>Firebase Admin not configured</strong><br>
                                Bundle/topic management requires Firebase Admin SDK setup.<br>
                                Please configure FIREBASE_SERVICE_ACCOUNT_JSON or place service-account-key.json in the server directory.
                            </div>
                        `;
                    } else {
                        document.getElementById('bundlesLoading').textContent = 'Error loading bundles: ' + (data.message || data.error);
                    }
                }
            } catch (error) {
                console.error('Error loading bundles:', error);
                document.getElementById('bundlesLoading').textContent = 'Error loading bundles: ' + error.message;
            }
        }

        // ==================== DELETE ACTIONS ====================

        async function deleteCode(code) {
            if (!confirm(`Are you sure you want to delete access code "${code}"?\n\nThis action cannot be undone.`)) return;
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/access-codes/${code}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Access code deleted successfully');
                    loadAccessCodes();
                    loadStatistics();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete code'));
                }
            } catch (error) {
                alert('‚ùå Error deleting code: ' + error.message);
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm(`Are you sure you want to delete order "${orderId}"?\n\nThis will also delete all associated access codes.\n\nThis action cannot be undone.`)) return;
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Order and associated access codes deleted successfully');
                    loadOrders();
                    loadAccessCodes();
                    loadStatistics();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete order'));
                }
            } catch (error) {
                alert('‚ùå Error deleting order: ' + error.message);
            }
        }

        async function deleteUser(email) {
            if (!confirm(`‚ö†Ô∏è WARNING: Are you sure you want to delete ALL data for user "${email}"?\n\nThis will delete:\n- All orders\n- All access codes\n- All user information\n\nThis action CANNOT be undone!`)) return;
            const confirmText = prompt(`Type "DELETE" to confirm deletion of all data for ${email}:`);
            if (confirmText !== 'DELETE') { alert('Deletion cancelled'); return; }
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();
                if (data.success) {
                    alert(`‚úÖ User data deleted successfully\n\nDeleted:\n- ${data.deletedOrders} orders\n- ${data.deletedCodes} access codes`);
                    loadUsers();
                    loadOrders();
                    loadAccessCodes();
                    loadStatistics();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete user'));
                }
            } catch (error) {
                alert('‚ùå Error deleting user: ' + error.message);
            }
        }

        async function deleteBundle(bundleId, bundleName) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete bundle "${bundleName}"?\n\nThis will delete ALL topics in this bundle.\n\nThis action cannot be undone.`)) return;
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/bundles/${bundleId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Bundle deleted successfully');
                    loadBundles();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete bundle'));
                }
            } catch (error) {
                alert('‚ùå Error deleting bundle: ' + error.message);
            }
        }

        async function deleteTopic(bundleId, topicId, topicName) {
            if (!confirm(`Are you sure you want to delete topic "${topicName}"?\n\nThis action cannot be undone.`)) return;
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/bundles/${bundleId}/topics/${topicId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': adminPassword },
                });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Topic deleted successfully');
                    loadBundles();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'Failed to delete topic'));
                }
            } catch (error) {
                alert('‚ùå Error deleting topic: ' + error.message);
            }
        }

        // ==================== HELPERS ====================

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            const tabMap = {
                orders:  { index: 0, contentId: 'ordersTab' },
                codes:   { index: 1, contentId: 'codesTab' },
                users:   { index: 2, contentId: 'usersTab' },
                bundles: { index: 3, contentId: 'bundlesTab' },
            };

            const info = tabMap[tab];
            if (!info) return;

            const tabButtons = document.querySelectorAll('.tab');
            if (tabButtons[info.index]) tabButtons[info.index].classList.add('active');
            document.getElementById(info.contentId).classList.add('active');
            if (tab === 'bundles') loadBundles();
        }

        function filterTable(tableId, searchId) {
            const input = document.getElementById(searchId);
            const filter = input.value.toLowerCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td');
                let found = false;
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        const txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toLowerCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        function filterBundlesTable() {
            const input = document.getElementById('bundlesSearch');
            const filter = input.value.toLowerCase();
            const bundles = document.querySelectorAll('#bundlesList > div');

            bundles.forEach(bundleCard => {
                const text = bundleCard.textContent || bundleCard.innerText;
                bundleCard.style.display = text.toLowerCase().indexOf(filter) > -1 ? '' : 'none';
            });
        }
    </script>
</body>
</html>
